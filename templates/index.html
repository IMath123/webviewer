<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebViewer</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --text-color: #e0e0e0;
            --accent: #00d4aa;
            --sidebar-bg: linear-gradient(135deg, #2d2d2d 0%, #1e1e1e 100%);
            --sidebar-header-bg: linear-gradient(135deg, #252525 0%, #1a1a1a 100%);
            --border-color: #404040;
            --sidebar-border: #404040;
            --sidebar-shadow: rgba(0, 0, 0, 0.3);
            --control-bg: rgba(255, 255, 255, 0.03);
            --control-border: rgba(255, 255, 255, 0.08);
            --control-hover-bg: rgba(255, 255, 255, 0.05);
            --control-hover-border: rgba(255, 255, 255, 0.12);
            --button-bg: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%);
            --button-hover-bg: linear-gradient(135deg, #4a4a4a 0%, #3a3a3a 100%);
            --input-bg: #2a2a2a;
            --input-border: #555;
            --input-focus-border: #00d4aa;
            --canvas-bg: #0f0f0f;
            --scrollbar-track: #2a2a2a;
            --scrollbar-thumb: #555;
            --scrollbar-thumb-hover: #666;
            --info-bg: #252525;
            --info-border: #404040;
            --fps-color: #00d4aa;
            --control-label-color: #b0b0b0;
            --button-border: #555;
            --button-hover-border: #666;
            --slider-bg: #404040;
            --slider-hover-bg: #505050;
            --slider-thumb-bg: linear-gradient(135deg, #00d4aa 0%, #00b894 100%);
            --slider-thumb-shadow: rgba(0, 212, 170, 0.4);
            --dropdown-hover-bg: #323232;
            --dropdown-hover-border: #666;
            --checkbox-accent: #00d4aa;
            --sidebar-control-bg: rgba(255, 255, 255, 0.1);
            --sidebar-control-border: rgba(255, 255, 255, 0.2);
            --sidebar-control-hover-bg: rgba(255, 255, 255, 0.15);
            --sidebar-control-hover-border: rgba(255, 255, 255, 0.3);
            --expand-button-bg: linear-gradient(135deg, #2d2d2d 0%, #1e1e1e 100%);
            --expand-button-hover-bg: linear-gradient(135deg, #353535 0%, #262626 100%);
            --expand-button-border: #404040;
            --expand-button-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            --expand-button-hover-shadow: 0 6px 25px rgba(0, 0, 0, 0.5);
            --button-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --button-active-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            --fps-shadow: 0 0 10px rgba(0, 212, 170, 0.3);
            --modal-btn-danger-hover-bg: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            --container-bg: rgba(255, 255, 255, 0.02);
            --container-border: rgba(255, 255, 255, 0.05);
            --container-hover-bg: rgba(255, 255, 255, 0.03);
            --container-hover-border: rgba(255, 255, 255, 0.08);
        }
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
        }
        
        .container {
            display: flex;
            width: 100%;
            height: 100%;
            position: relative;
            flex-direction: row-reverse;
        }
        
        #canvas {
            display: block;
            height: 100%;
            flex: 1;
            background: var(--canvas-bg);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #sidebar {
            width: 300px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }
        
        #sidebarHeader {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            background: var(--sidebar-header-bg);
        }
        
        #viewerName {
            font-weight: bold;
            color: var(--text-color);
            font-size: 16px;
        }
        
        #sidebarControls {
            display: flex;
            justify-content: flex-end;
            padding: 8px 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        #page {
            flex: 1;
            overflow-y: auto;
            padding: 20px 0;
        }
        
        .page {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .page.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        body.sidebar-collapsed #sidebar {
            transform: translateX(100%);
            position: absolute;
            right: 0;
            top: 0;
        }
        
        #sidebar::-webkit-scrollbar {
            width: 6px;
        }
        
        #sidebar::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
        }
        
        #sidebar::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 3px;
        }
        
        #sidebar::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover);
        }
        
        #pinButton, #collapseButton {
            cursor: pointer;
            background: var(--sidebar-control-bg);
            border: 1px solid var(--sidebar-control-border);
            color: var(--text-color);
            font-size: 16px;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }
        
        #pinButton:hover, #collapseButton:hover {
            background: var(--sidebar-control-hover-bg);
            border-color: var(--sidebar-control-hover-border);
            transform: translateY(-1px);
        }
        
        #pinButton.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--text-color);
        }
        
        #collapseButton .icon {
            transform: rotate(180deg);
        }
        
        #expandButton {
            position: fixed;
            top: 15px;
            right: 15px;
            cursor: pointer;
            background: var(--expand-button-bg);
            color: var(--text-color);
            border: 1px solid var(--expand-button-border);
            border-radius: 8px;
            padding: 12px;
            font-size: 18px;
            display: none;
            z-index: 200;
            box-shadow: var(--expand-button-shadow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #expandButton:hover {
            background: var(--expand-button-hover-bg);
            transform: scale(1.05) translateY(-2px);
            box-shadow: var(--expand-button-hover-shadow);
        }
        
        .icon {
            width: 20px;
            height: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 控件通用样式 */
        .control-group {
            margin: 0 12px 8px 12px;
            padding: 8px;
            background: var(--control-bg);
            border: 1px solid var(--control-border);
            border-radius: 6px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .control-group:hover {
            background: var(--control-hover-bg);
            border-color: var(--control-hover-border);
            transform: translateY(-1px);
        }
        
        .control-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--control-label-color);
            margin-bottom: 4px;
            display: block;
        }
        
        /* 按钮样式 */
        .control-button {
            background: var(--button-bg);
            color: var(--text-color);
            border: 1px solid var(--button-border);
            padding: 8px 12px;
            margin-bottom: 4px;
            cursor: pointer;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            text-align: center;
            box-shadow: var(--button-shadow);
        }
        
        .control-button:hover {
            background: var(--button-hover-bg);
            border-color: var(--button-hover-border);
            transform: translateY(-1px);
            box-shadow: var(--button-shadow);
        }
        
        .control-button:active {
            transform: translateY(0);
            box-shadow: var(--button-active-shadow);
        }
        
        /* 滑块样式 */
        .slider-container {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        .slider-input {
            width: 50px;
            text-align: center;
            font-size: 12px;
            padding: 4px 6px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            background: var(--input-bg);
            color: var(--text-color);
            outline: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .slider-input:focus {
            border-color: var(--input-focus-border);
            box-shadow: 0 0 0 2px rgba(0, 212, 170, 0.2);
        }
        
        .slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 4px;
            background: var(--slider-bg);
            outline: none;
            border-radius: 2px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .slider:hover {
            background: var(--slider-hover-bg);
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--slider-thumb-bg);
            cursor: pointer;
            border-radius: 50%;
            box-shadow: var(--slider-thumb-shadow);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 212, 170, 0.6);
        }
        
        .slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--slider-thumb-bg);
            cursor: pointer;
            border-radius: 50%;
            border: none;
            box-shadow: var(--slider-thumb-shadow);
        }
        
        /* 文本样式 */
        .control-text {
            font-size: 13px;
            color: var(--text-color);
            padding: 4px 0;
            line-height: 1.3;
        }
        
        /* 下拉框样式 */
        .control-dropdown {
            width: 100%;
            padding: 6px 10px;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 6px;
            color: var(--text-color);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
        }
        
        .control-dropdown:hover {
            border-color: var(--dropdown-hover-border);
            background: var(--dropdown-hover-bg);
        }
        
        .control-dropdown:focus {
            border-color: var(--input-focus-border);
            box-shadow: 0 0 0 2px rgba(0, 212, 170, 0.2);
        }
        
        /* 复选框样式 */
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 2px 0;
        }
        
        .control-checkbox {
            width: 16px;
            height: 16px;
            accent-color: var(--checkbox-accent);
            cursor: pointer;
        }
        
        /* 输入框样式 */
        .inputbox-container {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .control-inputbox {
            width: 100%;
            padding: 6px 10px;
            background: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 6px;
            color: var(--text-color);
            font-size: 14px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
        }
        
        .control-inputbox:focus {
            border-color: var(--input-focus-border);
            box-shadow: 0 0 0 2px rgba(0, 212, 170, 0.2);
        }
        
        .inputbox-desc {
            font-size: 11px;
            color: var(--control-label-color);
            margin-top: 2px;
        }
        
        .inputbox-checkmark {
            color: var(--accent);
            font-size: 14px;
            display: none;
            margin-left: 6px;
        }
        
        /* 分割线样式 */
        .control-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, var(--info-border) 50%, transparent 100%);
            margin: 12px 0;
            border: none;
        }
        
        /* 手风琴样式 */
        .accordion-header {
            background: var(--button-bg);
            border: 1px solid var(--button-border);
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 4px;
            box-shadow: var(--button-shadow);
        }
        
        .accordion-header:hover {
            background: var(--button-hover-bg);
            border-color: var(--button-hover-border);
        }
        
        .accordion-arrow {
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--accent);
        }
        
        .accordion-arrow.down {
            transform: rotate(90deg);
        }
        
        .accordion-content {
            padding: 8px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            margin-bottom: 4px;
            animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideDown {
            from { opacity: 0; max-height: 0; }
            to { opacity: 1; max-height: 500px; }
        }
        
        /* 标签页样式 */
        .tab-container {
            border: 1px solid var(--button-border);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .tab-header {
            display: flex;
            background: var(--input-bg);
            border-bottom: 1px solid var(--button-border);
        }
        
        .tab {
            flex: 1;
            padding: 8px 12px;
            background: var(--input-bg);
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border-right: 1px solid var(--button-border);
        }
        
        .tab:last-child {
            border-right: none;
        }
        
        .tab:hover {
            background: var(--dropdown-hover-bg);
            color: var(--text-color);
        }
        
        .tab.active {
            background: var(--accent);
            color: var(--text-color);
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
            padding: 12px;
            background: var(--control-bg);
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* 图片样式 */
        .control-image {
            max-width: 100%;
            border-radius: 6px;
            border: 1px solid var(--button-border);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .control-image:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        /* 表格样式 */
        .table-container {
            width: 100%;
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .table-container::-webkit-scrollbar {
            height: 6px;
        }
        
        .table-container::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
            border-radius: 3px;
        }
        
        .table-container::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 3px;
        }
        
        .table-container::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover);
        }
        
        .control-table {
            width: 100%;
            min-width: 600px; /* 设置最小宽度确保内容不会挤压 */
            border-collapse: collapse;
            margin: 0;
            background: var(--control-bg);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .control-table th {
            background: var(--button-bg);
            color: var(--text-color);
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            border-bottom: 1px solid var(--control-border);
            white-space: nowrap;
            min-width: 100px; /* 增加最小宽度 */
            max-width: 200px; /* 设置最大宽度 */
        }
        
        .control-table th span {
            display: inline-block;
            vertical-align: middle;
        }
        
        .control-table th .sort-icon {
            margin-left: 8px;
            color: var(--accent);
            cursor: pointer;
            font-size: 12px;
            opacity: 0.7;
            transition: opacity 0.2s ease;
            flex-shrink: 0; /* 防止图标被压缩 */
        }
        
        .control-table th .sort-icon:hover {
            opacity: 1;
        }
        
        .control-table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--control-border);
            color: var(--text-color);
        }
        
        .control-table tr:last-child td {
            border-bottom: none;
        }
        
        .control-table tr:hover {
            background: var(--control-hover-bg);
        }
        
        .control-table .table-row.selectable {
            cursor: pointer;
        }
        
        .control-table .table-row.selectable:hover {
            background: var(--control-hover-bg);
        }
        
        .control-table .table-row.selected {
            background: rgba(0, 212, 170, 0.1);
            border-left: 3px solid var(--accent);
        }
        
        @keyframes modalSlideIn {
            from { 
                opacity: 0; 
                transform: scale(0.9) translateY(-20px);
            }
            to { 
                opacity: 1; 
                transform: scale(1) translateY(0);
            }
        }
        
        /* Container 容器样式 */
        .control-container {
            background: var(--container-bg);
            border: 1px solid var(--container-border);
            border-radius: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .control-container:hover {
            background: var(--container-hover-bg);
            border-color: var(--container-hover-border);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .control-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--accent), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .control-container:hover::before {
            opacity: 1;
        }
        
        .container-vertical {
            display: flex;
            flex-direction: column;
            align-items: stretch;
        }
        
        .container-horizontal {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            flex-wrap: wrap;
            gap: var(--gap, 6px);
            justify-content: flex-start;
        }
        
        .container-horizontal .control-group {
            flex-shrink: 1;
            flex-grow: 0;
            margin: 0;
            padding: 2px;
            min-width: 60px;
            max-width: 150px;
        }
        
        /* 为不同类型的控件设置更紧凑的最小宽度 */
        .container-horizontal .control-group:has(.control-button) {
            min-width: 45px;
        }
        
        .container-horizontal .control-group:has(.control-slider) {
            min-width: 80px;
        }
        
        .container-horizontal .control-group:has(.control-dropdown) {
            min-width: 60px;
        }
        
        .container-horizontal .control-group:has(.control-inputbox) {
            min-width: 90px;
        }
        
        .container-horizontal .control-group:has(.control-checkbox) {
            min-width: 45px;
        }
        
        .container-horizontal .control-group:has(.control-text) {
            min-width: 40px;
        }
        
        /* 控件样式优化 */
        .container-horizontal .control-label {
            font-size: 9px;
            margin-bottom: 1px;
            line-height: 1.1;
        }
        
        .container-horizontal .control-button {
            padding: 3px 4px;
            font-size: 10px;
            margin-bottom: 1px;
            min-height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .container-horizontal .control-dropdown {
            padding: 2px 3px;
            font-size: 10px;
            min-height: 18px;
            min-width: 50px;
        }
        
        .container-horizontal .control-inputbox {
            padding: 2px 3px;
            font-size: 10px;
            min-height: 18px;
            min-width: 60px;
        }
        
        .container-horizontal .slider {
            height: 1px;
        }
        
        .container-horizontal .slider::-webkit-slider-thumb {
            width: 10px;
            height: 10px;
        }
        
        .container-horizontal .slider::-moz-range-thumb {
            width: 10px;
            height: 10px;
        }
        
        .container-horizontal .slider-input {
            min-width: 25px;
            font-size: 9px;
            padding: 1px 2px;
        }
        
        .container-horizontal .control-text {
            font-size: 10px;
            padding: 1px 0;
            min-height: 14px;
            display: flex;
            align-items: center;
        }
        
        .container-horizontal .checkbox-container {
            gap: 3px;
            padding: 0;
        }
        
        .container-horizontal .control-checkbox {
            width: 12px;
            height: 12px;
        }
        
        .container-horizontal .inputbox-desc {
            font-size: 8px;
            margin-top: 0;
        }
        
        .container-horizontal .slider-container {
            gap: 1px;
        }
        
        .container-horizontal .slider-header {
            gap: 2px;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .container-horizontal {
                flex-direction: column;
            }
            
            .container-horizontal .control-group {
                width: 100%;
                min-width: 100%;
                max-width: 100%;
            }
        }
        
        /* Progress 进度条样式 */
        .progress-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: var(--control-bg);
            border: 1px solid var(--control-border);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d4aa, #00b894);
            border-radius: 10px;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .progress-text {
            font-size: 12px;
            color: var(--text-color);
            text-align: center;
            font-weight: 500;
        }
        
        /* 进度条悬停效果 */
        .progress-bar:hover {
            border-color: var(--control-hover-border);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        /* 进度条在不同主题下的样式 */
        .theme-one-dark .progress-fill {
            background: linear-gradient(90deg, #00d4aa, #00b894);
        }
        
        .theme-one-light .progress-fill {
            background: linear-gradient(90deg, #00b894, #00a085);
        }
        
        .theme-github-dark .progress-fill {
            background: linear-gradient(90deg, #58a6ff, #1f6feb);
        }
        
        .theme-github-light .progress-fill {
            background: linear-gradient(90deg, #0969da, #1a7f37);
        }
    </style>
    <link rel="stylesheet" href="themes/theme-one-dark.css">
    <link rel="stylesheet" href="themes/theme-one-light.css">
    <link rel="stylesheet" href="themes/theme-github-dark.css">
    <link rel="stylesheet" href="themes/theme-github-light.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
</head>
<body>
    <div class="container">
        <div id="sidebar">
            <div id="sidebarHeader">
                <div id="viewerName">Viewer</div>
                <button id="pinButton" class="active" title="固定侧边栏"><span class="icon">📌</span></button>
            </div>
            <div id="sidebarControls">
                <button id="collapseButton" title="折叠侧边栏"><span class="icon">◀</span></button>
            </div>
            <div id="page"></div>
        </div>
        <canvas id="canvas"></canvas>
    </div>
    <button id="expandButton" title="展开侧边栏"><span class="icon">◀</span></button>
    
    <script>
        var socket = io();
        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext('2d');
        var fpsDisplay = document.getElementById('fps');
        var imageWidth = 1024;
        var imageHeight = 1024;
        var currentImage = null;
        var drawing = false;
        var lastX, lastY;
        var lastFrameTime = performance.now();
        var frameCount = 0;

        const sidebar = document.getElementById('sidebar');
        const expandButton = document.getElementById('expandButton');
        const collapseButton = document.getElementById('collapseButton');
        const pinButton = document.getElementById('pinButton');
        let sidebarPinned = true;

        // 处理侧边栏折叠和展开
        document.getElementById('collapseButton').addEventListener('click', function() {
            document.body.classList.add('sidebar-collapsed');
            document.getElementById('expandButton').style.display = 'block';
            resizeCanvas(true);
        });

        document.getElementById('expandButton').addEventListener('click', function() {
            document.body.classList.remove('sidebar-collapsed');
            document.getElementById('expandButton').style.display = 'none';
            resizeCanvas(true);
        });

        document.getElementById('pinButton').addEventListener('click', function() {
            this.classList.toggle('active');
            const isPinned = this.classList.contains('active');
            if (isPinned) {
                this.querySelector('.icon').textContent = '📍';
                collapseButton.style.display = 'none';
            } else {
                this.querySelector('.icon').textContent = '📌';
                collapseButton.style.display = 'block';
            }
        });

        sidebar.addEventListener('mouseleave', function() {
            const isPinned = document.getElementById('pinButton').classList.contains('active');
            if (!isPinned) {
                document.body.classList.add('sidebar-collapsed');
                document.getElementById('expandButton').style.display = 'block';
                resizeCanvas(true);
            }
        });

        function resizeCanvas(send_to_backend) {
            canvas.width = document.body.classList.contains('sidebar-collapsed') ? 
                window.innerWidth : 
                window.innerWidth - sidebar.offsetWidth;
            canvas.height = window.innerHeight;
            var aspectRatio = canvas.height / canvas.width;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (currentImage) {
                ctx.drawImage(currentImage, 0, 0, canvas.width, canvas.height);
            }
            if (send_to_backend) {
                socket.emit('set_aspect_ratio', {aspect_ratio: aspectRatio});
            }
            socket.emit('send_canvas_size', {canvas_width: canvas.width, canvas_height: canvas.height});
        }

        window.addEventListener('resize', () => resizeCanvas(true));

        window.addEventListener('load', function() {
            document.body.classList.remove('sidebar-collapsed');
            expandButton.style.display = 'none';
            resizeCanvas(true);
            if (pinButton.classList.contains('active')) {
                pinButton.querySelector('.icon').textContent = '📍';
                collapseButton.style.display = 'none';
            } else {
                pinButton.querySelector('.icon').textContent = '📌';
                collapseButton.style.display = 'block';
            }
        });

        function updatePosition(x, y) {
            if (lastX != null && lastY != null) {
                socket.emit('update_mouse_position', {x: x, y: y, last_x: lastX, last_y: lastY})
            }
            lastX = x;
            lastY = y;
        }
        
        canvas.addEventListener('mousedown', function(event) {
            if (event.button === 0) {
                socket.emit('on_left_mouse_press'); 
            } else if (event.button === 2) {
                socket.emit('on_right_mouse_press');
            }
        });

        canvas.addEventListener('mouseup', function(event) {
            if (event.button === 0) {
                socket.emit('on_left_mouse_release'); 
            } else if (event.button === 2) {
                socket.emit('on_right_mouse_release');
            }
        });

        canvas.addEventListener('mouseleave', function(event) {
            socket.emit('on_left_mouse_release'); 
            socket.emit('on_right_mouse_release');
        });

        canvas.addEventListener('mousemove', function(event) {
            updatePosition(event.clientX, event.clientY);
        });
        
        canvas.addEventListener('wheel', function(event) {
            event.preventDefault();
            const delta = event.deltaY;
            socket.emit('on_mouse_wheel', {delta: delta});
        });

        canvas.addEventListener('contextmenu', function(event) {
            event.preventDefault();
        });

        canvas.addEventListener('touchstart', function(event) {
            socket.emit('on_left_mouse_press'); 
        });

        canvas.addEventListener('touchend', function(event) {
            socket.emit('on_left_mouse_release'); 
        });

        canvas.addEventListener('touchcancel', function(event) {
            socket.emit('on_left_mouse_release'); 
        });

        canvas.addEventListener('touchmove', function(event) {
            const touch = event.touches[0];
            updatePosition(touch.clientX, touch.clientY);
        });

        socket.on('draw_response', function(data) {
            var blob = new Blob([data], {type: 'image/jpeg'});
            var url = URL.createObjectURL(blob);
            var img = new Image();
            img.src = url;
            img.onload = function() {
                currentImage = img;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                URL.revokeObjectURL(url);

                frameCount++;
                var now = performance.now();
                var elapsed = now - lastFrameTime;
                if (elapsed >= 1000) {
                    var fps = (frameCount / elapsed) * 1000;
                    fpsDisplay.textContent = `FPS: ${fps.toFixed(1)}`;
                    frameCount = 0;
                    lastFrameTime = now;
                }
            };
        });
        
        socket.on('connect', function() {
            console.log('WebSocket connected');
            
            if (pinButton.classList.contains('active')) {
                collapseButton.style.display = 'none';
            } else {
                collapseButton.style.display = 'block';
            }
            
            const isSidebarCollapsed = document.body.classList.contains('sidebar-collapsed');
            resizeCanvas(!isSidebarCollapsed);
            
            socket.emit('set_image_size_by_canvas_size', {width: canvas.width, height: canvas.height});
        });

        socket.on('set_image_size', function(data) {
            imageWidth = data.width;
            imageHeight = data.height;
        });

        socket.on('disconnect', function() {
            console.log('WebSocket disconnected');
        });

        socket.on('render_controls', function(data) {
            var page = document.getElementById('page');
            // 彻底清空 page
            page.innerHTML = '';
            // 创建并插入新的 controls
            var controls = document.createElement('div');
            controls.id = 'controls';
            controls.innerHTML = data.htmls;
            // 查看page的child的数量
            page.appendChild(controls);

            var content = data.contents;
            for (var i = 0; i < content.length; i++) {
                (function(contentItem) {
                    if (contentItem.type === 'button') {
                        var button_id = contentItem.id;
                        var button = document.getElementById(button_id);
                        var button_func = contentItem.id;
                    
                        button.addEventListener('click', function() {
                            socket.emit(button_func, {});
                        });
                        socket.on('update_' + button_id, function(data) {
                            var value = data.text;
                            button.textContent = value;
                            socket.emit(button_func, {});
                        });
                    }
                    else if (contentItem.type === 'inputbox') {
                        var inputbox_id = contentItem.id;
                        var inputbox = document.getElementById(inputbox_id);
                        var inputbox_func = contentItem.id;
                        var checkmark = document.getElementById(inputbox_id + '-checkmark');
                        
                        inputbox.value = contentItem.content;
                    
                        inputbox.addEventListener('keydown', function(event) {
                            if (event.key === 'Enter') {
                                checkmark.style.display = 'inline';
                                inputbox.blur();
                                socket.emit(inputbox_func, {content: inputbox.value})
                            }
                        });
                        inputbox.addEventListener('input', function() {
                            checkmark.style.display = 'none';
                        });
                        socket.on('update_' + inputbox_id, function(data) {
                            inputbox.value = data.content;
                            socket.emit(inputbox_func, {content: inputbox.value});
                        });
                    }
                    else if (contentItem.type === 'slider') {
                        var slider_id = contentItem.id;
                        var slider_text = contentItem.text;
                        var init_value = contentItem.value;
                        var slider_min = parseFloat(contentItem.min);
                        var slider_max = parseFloat(contentItem.max);
                        var slider = document.getElementById(slider_id);
                        var sliderValueInput = document.getElementById(slider_id + '-slider-value-input');
                        
                        slider.value = init_value
                        sliderValueInput.textContent = init_value;

                        var slider_func = contentItem.id;
                       
                        slider.addEventListener('input', function() {
                            var value = slider.value;
                            sliderValueInput.textContent = value;
                            sliderValueInput.value = value;
                            socket.emit(slider_func, {value: value});
                        });
                        
                        sliderValueInput.addEventListener('keydown', function() {
                            if (event.key === 'Enter') {
                                var value = sliderValueInput.value;
                                console.log("input ", value);
                                if (!isNaN(value)) {
                                    if (value > slider_max) {
                                        console.log("over max");
                                        value = slider_max;
                                    }
                                    if (value < slider_min) {
                                        value = slider_min;
                                    }
                                    console.log(value, slider_min, slider_max);
                                    slider.value = value;
                                    sliderValueInput.value = value;
                                    sliderValueInput.textContent = value;
                                }
                                sliderValueInput.blur();
                            }
                        });
                        sliderValueInput.addEventListener('input', function() {
                            const value = sliderValueInput.value;
                            if (!isNaN(value) && value >= slider_min && value <= slider_max) {
                                slider.value = value;
                                sliderValueInput.value = value;
                                socket.emit(slider_func, {value: value});
                            }
                        });
                        
                        sliderValueInput.addEventListener('blur', function() {
                            let value = sliderValueInput.value;
                            if (isNaN(value) || value < slider_min) {
                                value = slider_min;
                            } else if (value > slider_max) {
                                value = slider_max;
                            }
                            sliderValueInput.value = value;
                            sliderValueInput.textContent = value;
                            slider.value = value;
                            socket.emit(slider_func, {value: value});
                        });

                        socket.on('update_' + slider_id, function(data) {
                            var value = data.value;
                            slider.value = value;
                            sliderValueInput.textContent = value;
                            socket.emit(slider_func, {value: value});
                        });
                    } else if (contentItem.type === 'text') {
                        var text_id = contentItem.id;
                        var text = document.getElementById(text_id);
                        var text_value = contentItem.text;

                        text.innerHTML = text_value;
                        socket.on('update_' + text_id, function(data) {
                            var value = data.text;
                            text.innerHTML = value;
                        });

                    } else if (contentItem.type === 'dropdown') {
                        var dropdown_id = contentItem.id;
                        var dropdown = document.getElementById(dropdown_id);
                        var dropdown_value = contentItem.option
                        var dropdown_func = contentItem.id;

                        dropdown.value = dropdown_value

                        dropdown.addEventListener('change', function() {
                            var value = dropdown.value;
                            // 主题切换专用
                            if(dropdown_id === 'theme_dropdown') {
                                setTheme('theme-' + value);
                            }
                            socket.emit(dropdown_func, {option: value});
                        });
                        
                        socket.on('update_' + dropdown_id, function(data) {
                            var option = data.option;
                            dropdown.value = option;
                            // 主题切换专用
                            if(dropdown_id === 'theme_dropdown') {
                                setTheme('theme-' + option);
                            }
                        });
                        
                    } else if (contentItem.type === 'checkbox') {
                        var checkbox_id = contentItem.id;
                        var checkbox = document.getElementById(checkbox_id);
                        var checkbox_func = contentItem.id;
                        var checkbox_value = contentItem.checked

                        checkbox.checked = checkbox_value === 'true'
                        
                        checkbox.addEventListener('change', function() {
                            var value = checkbox.checked;
                            socket.emit(checkbox_func, {checked: value})
                         });
                        socket.on('update_' + checkbox_id, function(data) {
                            var checked = data.checked;
                            checkbox.checked = checked === 'true'
                            socket.emit(checkbox_func, {checked: checkbox.checked})
                        });
                    } else if (contentItem.type == "image") {
                        var image_id = contentItem.id;
                        const image = document.getElementById(image_id);
                        var image_func = contentItem.id;

                        image.src = 'data:image/jpeg;base64,' + contentItem.image;

                        // 添加点击事件监听器
                        image.addEventListener('click', function() {
                            socket.emit(image_func, {});
                        });

                        socket.on('update_' + image_id, function(data) {
                            var image_data = data.image;
                            image.src = 'data:image/jpeg;base64,' + image_data;
                        });

                    } else if (contentItem.type === 'accordion') {
                        var accordion_id = contentItem.id;
                        const accordion = document.getElementById(accordion_id);
                        const arrow = document.getElementById(accordion_id + '-arrow');
                        const nestedControls = document.getElementById(accordion_id + '-nestedControls');

                        var expanded = contentItem.expanded;
                        if (expanded === 'true') {
                            if (nestedControls.style.display !== 'block') { 
                                nestedControls.style.display = 'block';
                                arrow.classList.remove('right');
                                arrow.classList.add('down');
                            }
                        } else {
                            if (nestedControls.style.display === 'block') { 
                                nestedControls.style.display = 'none';
                                arrow.classList.remove('down');
                                arrow.classList.add('right');
                            }
                        }

                        accordion.addEventListener('click', function() {
                            if (nestedControls.style.display === 'none' || nestedControls.style.display === '') {
                                nestedControls.style.display = 'block';
                                arrow.classList.remove('right');
                                arrow.classList.add('down');
                            } else {
                                nestedControls.style.display = 'none';
                                arrow.classList.remove('down');
                                arrow.classList.add('right');
                            }
                            socket.emit(accordion_id, {expanded: nestedControls.style.display === 'block'});
                        });
                        socket.on('update_' + accordion_id, function (data) {
                            var expanded = data.expanded;
                            if (expanded === 'true') {
                                nestedControls.style.display = 'block';
                                arrow.classList.remove('right');
                                arrow.classList.add('down');
                            } else {
                                nestedControls.style.display = 'none';
                                arrow.classList.remove('down');
                                arrow.classList.add('right');
                            }
                            socket.emit(accordion_id, {expanded: nestedControls.style.display === 'block'});
                        });
                    } else if (contentItem.type === 'tab') {
                        var tab_id = contentItem.id;
                        const tab = document.getElementById(tab_id);
                        const active_tab_id = contentItem.active_tab_id;
                        
                        const tabs = document.querySelectorAll('.tab');
                        const pages = document.querySelectorAll('.tab-content');

                        tabs.forEach(t => t.classList.remove('active'));
                        pages.forEach(p => p.classList.remove('active'));

                        var t = tabs[active_tab_id];
                        t.classList.add('active');

                        const pageId = t.getAttribute('data-page');
                        document.getElementById(pageId).classList.add('active');

                        tabs.forEach(tab => {
                            tab.addEventListener('click', function() {
                                tabs.forEach(t => t.classList.remove('active'));
                                pages.forEach(p => p.classList.remove('active'));

                                this.classList.add('active');

                                const pageId = this.getAttribute('data-page');
                                document.getElementById(pageId).classList.add('active');
                                
                                var parts = pageId.split('-');
                                var active_id = parseInt(parts[parts.length - 1]);
                                socket.emit(tab_id, {active_tab: active_id});
                            });
                        });
                    } else if (contentItem.type === 'progress') {
                        var progress_id = contentItem.id;
                        const progressContainer = document.getElementById(progress_id);
                        var progress_func = contentItem.id;
                        var progress_value = contentItem.value;
                        var progress_min = contentItem.min_value;
                        var progress_max = contentItem.max_value;

                        // 更新进度条显示
                        const progressFill = progressContainer.querySelector('.progress-fill');
                        const progressText = progressContainer.querySelector('.progress-text');
                        const percentage = ((progress_value - progress_min) / (progress_max - progress_min)) * 100;
                        
                        progressFill.style.width = percentage + '%';
                        progressText.textContent = progress_value + '/' + progress_max + ' (' + percentage.toFixed(1) + '%)';

                        socket.on('update_' + progress_id, function(data) {
                            var value = data.value;
                            const percentage = ((value - progress_min) / (progress_max - progress_min)) * 100;
                            progressFill.style.width = percentage + '%';
                            progressText.textContent = value + '/' + progress_max + ' (' + percentage.toFixed(1) + '%)';
                        });

                    } else if (contentItem.type === 'colorpicker') {
                        var colorpicker_id = contentItem.id;
                        const colorpicker = document.getElementById(colorpicker_id);
                        const colorPreview = colorpicker.parentElement.querySelector('.color-preview');
                        const colorValue = colorpicker.parentElement.querySelector('.color-value');
                        var colorpicker_func = contentItem.id;
                        var colorpicker_color = contentItem.color;

                        colorpicker.value = colorpicker_color;
                        colorPreview.style.backgroundColor = colorpicker_color;
                        colorValue.textContent = colorpicker_color;

                        colorpicker.addEventListener('change', function() {
                            var color = colorpicker.value;
                            colorPreview.style.backgroundColor = color;
                            colorValue.textContent = color;
                            socket.emit(colorpicker_func, {color: color});
                        });

                        socket.on('update_' + colorpicker_id, function(data) {
                            var color = data.color;
                            colorpicker.value = color;
                            colorPreview.style.backgroundColor = color;
                            colorValue.textContent = color;
                        });

                    } else if (contentItem.type === 'table') {
                        var table_id = contentItem.id;
                        const table = document.getElementById(table_id);
                        var table_func = contentItem.id;
                        var table_sortable = contentItem.sortable;
                        var table_selectable = contentItem.selectable;

                        // 处理排序图标点击事件
                        if (table_sortable) {
                            const sortIcons = table.querySelectorAll('.sort-icon');
                            console.log('Found sort icons:', sortIcons.length);
                            sortIcons.forEach(function(icon) {
                                icon.addEventListener('click', function(e) {
                                    e.stopPropagation();
                                    const columnIndex = parseInt(this.getAttribute('data-column'));
                                    console.log('Sort icon clicked, column:', columnIndex);
                                    socket.emit(table_func, {action: 'sort', column: columnIndex});
                                });
                            });
                        }

                        // 处理行选择事件
                        if (table_selectable) {
                            const selectableRows = table.querySelectorAll('.table-row.selectable');
                            selectableRows.forEach(function(row) {
                                row.addEventListener('click', function() {
                                    const rowIndex = parseInt(this.getAttribute('data-row'));
                                    socket.emit(table_func, {action: 'select', row: rowIndex});
                                });
                            });
                        }

                        // 处理表格更新
                        socket.on('update_' + table_id, function(data) {
                            if (data.headers && data.data) {
                                // 重新生成表格内容
                                const thead = table.querySelector('thead tr');
                                const tbody = table.querySelector('tbody');
                                
                                // 更新表头
                                thead.innerHTML = '';
                                data.headers.forEach(function(header, index) {
                                    if (table_sortable) {
                                        thead.innerHTML += `<th>${header}<span class="sort-icon" data-column="${index}">⇅</span></th>`;
                                    } else {
                                        thead.innerHTML += `<th>${header}</th>`;
                                    }
                                });

                                // 更新数据行
                                tbody.innerHTML = '';
                                data.data.forEach(function(row, rowIndex) {
                                    const rowClass = table_selectable ? `class="table-row selectable" data-row="${rowIndex}"` : `class="table-row" data-row="${rowIndex}"`;
                                    let cellsHtml = '';
                                    row.forEach(function(cell) {
                                        cellsHtml += `<td>${cell}</td>`;
                                    });
                                    tbody.innerHTML += `<tr ${rowClass}>${cellsHtml}</tr>`;
                                });

                                // 重新绑定事件
                                if (table_sortable) {
                                    const sortIcons = table.querySelectorAll('.sort-icon');
                                    sortIcons.forEach(function(icon) {
                                        icon.addEventListener('click', function(e) {
                                            e.stopPropagation();
                                            const columnIndex = parseInt(this.getAttribute('data-column'));
                                            socket.emit(table_func, {action: 'sort', column: columnIndex});
                                        });
                                    });
                                }

                                if (table_selectable) {
                                    const selectableRows = table.querySelectorAll('.table-row.selectable');
                                    selectableRows.forEach(function(row) {
                                        row.addEventListener('click', function() {
                                            const rowIndex = parseInt(this.getAttribute('data-row'));
                                            socket.emit(table_func, {action: 'select', row: rowIndex});
                                        });
                                    });
                                }
                            }
                        });
                    } else if (contentItem.type === 'container') {
                        var container_id = contentItem.id;
                        const container = document.getElementById(container_id);
                        var container_func = contentItem.id;
                        var container_direction = contentItem.direction;
                        var container_gap = contentItem.gap;
                        var container_padding = contentItem.padding;
                        var container_control_count = contentItem.control_count;

                        // 容器控件本身的事件处理（如果需要）
                        container.addEventListener('click', function() {
                            socket.emit(container_func, {
                                direction: container_direction,
                                gap: container_gap,
                                padding: container_padding,
                            });
                        });

                        // 处理容器更新
                        socket.on('update_' + container_id, function(data) {
                            if (data.direction) {
                                container.className = container.className.replace(/container-(vertical|horizontal)/g, '');
                                container.classList.add('container-' + data.direction);
                                container_direction = data.direction;
                            }
                            if (data.gap) {
                                container.style.setProperty('--gap', data.gap);
                                container.style.gap = data.gap;
                                container_gap = data.gap;
                            }
                            if (data.padding) {
                                container.style.setProperty('--padding', data.padding);
                                container.style.padding = data.padding;
                                container_padding = data.padding;
                            }
                            if (data.control_count !== undefined) {
                                container_control_count = data.control_count;
                            }
                        });
                    }
                })(content[i]);
            }
        });
        
        sidebar.addEventListener('touchstart', function(event) {
            event.stopPropagation();
        }, { passive: false });

        sidebar.addEventListener('touchmove', function(event) {
            event.stopPropagation();
        }, { passive: false });

        resizeCanvas(true);

        // 主题切换逻辑
        function setTheme(theme) {
            // 移除所有可能的主题类
            document.body.classList.remove(
                'theme-one-dark', 'theme-one-light',
                'theme-github-dark', 'theme-github-light'
            );
            // 添加新主题类
            document.body.classList.add(theme);
        }
        // 默认主题由后端控制，不在这里设置
    </script>
</body>
</html>